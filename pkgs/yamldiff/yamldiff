#!/usr/bin/env python3
import sys
import yaml
import click


def diff(a, b):
    if a == b:
        return None

    if isinstance(b, dict):
        result = {}
        for k, bv in b.items():
            av = a.get(k) if isinstance(a, dict) else None

            if k not in a:
                result[k] = bv
            else:
                d = diff(av, bv)
                if d is not None:
                    result[k] = d

        return result or None
    else:
        return b


def load_yaml(path):
    try:
        if path == "-":
            return yaml.safe_load(sys.stdin) or {}
        with open(path) as f:
            return yaml.safe_load(f) or {}
    except Exception as e:
        raise click.ClickException(
            f"Error reading {path if path != "-" else "stdin"}: {e}"
        )


def dump_yaml(data):
    return yaml.safe_dump(data, sort_keys=False)


@click.command()
@click.argument("base", type=click.Path(exists=True, dir_okay=False))
@click.argument("modified", type=click.Path(exists=True, dir_okay=False))
def main(base, modified):
    """
    Generate YAML containing only new and changed values from MODIFIED compared to BASE.

    BASE      Base YAML file (A) or '-' for stdin

    MODIFIED  Modified YAML file (B) or '-' for stdin
    """
    a = load_yaml(base)
    b = load_yaml(modified)

    result = diff(a, b) or {}
    rendered = dump_yaml(result)

    sys.stdout.write(rendered)


if __name__ == "__main__":
    main()
